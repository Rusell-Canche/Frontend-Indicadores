<template>
  <div v-if="visible" class="modal fade show d-block" tabindex="-1">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <!-- Header -->
        <div class="modal-header bg-dark text-white">
          <h5 class="modal-title">
            Plantilla: {{ jsonData.nombre_plantilla || 'Sin nombre' }}
          </h5>
          <button type="button" class="btn-close btn-close-white" @click="cerrar"></button>
        </div>

        <!-- Body -->
        <div class="modal-body bg-light">
          <!-- Secciones -->
          <div
            v-for="(seccion, i) in jsonData.secciones || []"
            :key="i"
            class="mb-4 mt-3 p-3 border rounded"
            style="background-color: #808080;"
          >
            <h6 class="fw-bold text-black mb-3">
              Secci√≥n: {{ seccion.nombre }}
            </h6>

            <!-- Campos -->
            <div v-for="(campo, j) in seccion.fields || []" :key="j">
              <div v-html="renderCampo(campo, 1)"></div>
            </div>
          </div>
        </div>

        <!-- Footer -->
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" @click="cerrar">
            Cerrar
          </button>
        </div>
      </div>
    </div>
  </div>
</template>
<script>
export default {
  name: "VistaGrafica",
  props: {
    visible: { type: Boolean, default: false },
    jsonData: { type: Object, default: () => ({}) },
  },
  methods: {
    cerrar() {
      this.$emit("close");
    },

    // üîπ Nuevo m√©todo: devuelve color azul seg√∫n nivel
    getSubformColor(nivel) {
      const base = 192; // Azul medio (#0070C0)
      const ajuste = Math.min(80, nivel * 20); 
      return `rgb(${0}, ${112 + ajuste}, ${192 + ajuste})`;
    },

    renderCampo(campo, nivel) {
      const tab = nivel * 40; 
      let clases = "mb-3 mt-3 p-3 border rounded ";
      let estilos = `margin-left:${tab}px;`;

      if (
        (!campo.options || campo.options.length === 0) &&
        (!campo.subcampos || campo.subcampos.length === 0) &&
        campo.type !== "subform"
      ) {
        clases += "CamposSinElementos";
      } else if (campo.type === "subform") {
        estilos += `background-color:${this.getSubformColor(nivel)};`;
      } else if (campo.type === "select") {
        clases += "SelectsDivs";
      } else {
        clases += "SelectsDivs";
      }

      let html = `<div class="${clases}" style="${estilos}">`;
      html += `<strong>${campo.name || "Sin nombre"}</strong>`;
      if (campo.type) {
        html += ` <small class="text-muted">(${campo.type})</small>`;
      }

      if (campo.type === "select" && campo.options) {
        html += `<div class="mt-3">`;
        campo.options.forEach((opt) => {
          html += `
            <div class="mb-2 mt-2 p-2 border rounded CamposSinElementos" 
                 style="margin-left:${(nivel + 1) * 40}px">
              ${typeof opt === "object" ? opt.campoGuardar || JSON.stringify(opt) : opt}
            </div>`;
        });
        html += `</div>`;
      }

      if (campo.type === "subform" && campo.subcampos) {
        html += `<div class="mt-3 mb-3 p-3 border rounded" 
                     style="margin-left:${(nivel + 1) * 40}px; background-color:${this.getSubformColor(nivel + 1)};">`;
        html += `<h6 class="fw-semibold mb-3">Subformulario</h6>`;
        campo.subcampos.forEach((subcampo) => {
          html += this.renderCampo(subcampo, nivel + 2);
        });
        html += `</div>`;
      }

      html += `</div>`;
      return html;
    },
  },
};
</script>

<style>
.CamposSinElementos {
  background-color: #FFC000 !important;
}
.SelectsDivs {
  background-color: #00B050 !important;
}
</style>
